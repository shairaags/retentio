geom_line(aes(group = Compound), color = "black") +  # lignes noires
scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
geom_hline(yintercept = 30, linetype = "dashed", color = "red") +
theme_minimal() +
labs(title = "Cin√©tique des CV (%) des √©talons internes",
y = "CV (%)", x = "Date") +
theme(legend.position = "none")
ggsave(file, plot = p, width = 10, height = 6, dpi = 300)
}
)
output$cvBox2 <- renderValueBox({
df <- filtered_data_2()
if (all(is.na(df$CV))) return(valueBox("NA", subtitle = "CV%", color = "aqua"))
cv_moyen <- round(mean(df$CV, na.rm = TRUE), 1)
box_color <- if (cv_moyen < 30) "green" else "red"
valueBox(cv_moyen, subtitle = "CV%", color = box_color)
})
output$meanBox2 <- renderValueBox({
df <- filtered_data_2()
mean_val <- round(mean(df$Area, na.rm = TRUE), 2)
formatted <- format(mean_val, decimal.mark = ".", big.mark = "", scientific = FALSE)
valueBox(ifelse(is.na(mean_val), "NA", formatted), subtitle = "Aire Moyenne", color = "blue")
})
output$nSeqBox2 <- renderValueBox({
df <- filtered_data_2()
valueBox(length(unique(df$Sequence)), subtitle = "S√©quences", color = "purple")
})
output$dataTable2 <- renderDT({
datatable(filtered_data_2(), editable = "cell", options = list(pageLength = 10))
})
observeEvent(input$dataTable2_cell_edit, {
info <- input$dataTable2_cell_edit
df <- data_reactive_2()
if (info$col == which(colnames(df) == "Flagged")) {
df[info$row, "Flagged"] <- as.logical(info$value)
data_reactive_2(df)
}
})
output$CVPlot_time2 <- renderPlotly({
df <- filtered_data_2()
df$Date  <- as.Date(df$Date)
df <- df[order(df$Date), ]
plot_ly(df, x = ~Date, y = ~CV, type = 'scatter', mode = 'lines+markers') %>%
layout(yaxis = list(title = "CV (%)"))
})
output$areaPlot2 <- renderPlotly({
df <- filtered_data_2()
plot_ly(df, x = ~Date, y = ~Area, type = 'scatter', mode = 'lines+markers') %>%
layout(yaxis = list(title = "Aire"))
})
output$trendPlot2 <- renderPlotly({
df <- filtered_data_2()
summary <- df %>%
group_by(Date) %>%
summarise(Min = min(Area, na.rm = TRUE),
Max = max(Area, na.rm = TRUE),
Mean = mean(Area, na.rm = TRUE),
.groups = "drop")
plot_ly(summary, x = ~Date) %>%
add_lines(y = ~Min, name = "Min", line = list(color = "blue")) %>%
add_lines(y = ~Mean, name = "Moyenne", line = list(color = "orange")) %>%
add_lines(y = ~Max, name = "Max", line = list(color = "green")) %>%
layout(yaxis = list(title = "Tendance des Aires"))
})
# Fonction pour enregistrer le plot Aire log10 en PNG
output$download_area_plot <- downloadHandler(
filename = function() {
paste0("Area_plot_", Sys.Date(), ".png")
},
content = function(file) {
df <- data_reactive() %>%
filter(Compound %in% input$multi_analytes,
!is.na(Date), !is.na(Area), Area > 0)
# df <- data_reactive() %>%
#   filter(Type == "√âtalon Interne",
#          Compound %in% input$multi_analytes,
#          !is.na(Date), !is.na(Area), Area > 0)
if (nrow(df) == 0) return(NULL)
df_log <- df %>%
mutate(logArea = log10(Area)) %>%
filter(!is.na(logArea)) %>%
arrange(Date)  # ‚Üê tri par date
p <- ggplot(df_log, aes(x = Date, y = logArea, color = Compound)) +
geom_line() + geom_point() +
theme_minimal() +
labs(title = "Cin√©tique des Aires (log10) des √©talons internes",
y = "log10(Area)", x = "Date") +
theme(legend.position = "bottom")
ggsave(file, plot = p, width = 10, height = 6, dpi = 300)
}
)
output$download_cv_plot2 <- downloadHandler(
filename = function() {
paste0("CV_plot_ret2_", Sys.Date(), ".png")
},
content = function(file) {
df <- data_reactive_2() %>%
filter(Compound %in% input$multi_analytes2,
!is.na(Date), !is.na(Area), Area > 0)
if (nrow(df) == 0) return(NULL)
cv_data <- df %>%
filter(!is.na(CV)) %>%
arrange(Date)
p <- ggplot(cv_data, aes(x = Date, y = CV)) +
geom_point(aes(color = CV > 30)) +
geom_line(aes(group = Compound), color = "black") +
scale_color_manual(values = c("FALSE" = "black", "TRUE" = "red")) +
geom_hline(yintercept = 30, linetype = "dashed", color = "red") +
theme_minimal() +
labs(title = "Cin√©tique des CV (%) des √©talons internes",
y = "CV (%)", x = "Date") +
theme(legend.position = "none")
ggsave(file, plot = p, width = 10, height = 6, dpi = 300)
}
)
output$download_area_plot2 <- downloadHandler(
filename = function() {
paste0("Area_plot_ret2_", Sys.Date(), ".png")
},
content = function(file) {
df <- data_reactive_2() %>%
filter(Compound %in% input$multi_analytes2,
!is.na(Date), !is.na(Area), Area > 0)
if (nrow(df) == 0) return(NULL)
df_log <- df %>%
mutate(logArea = log10(Area)) %>%
filter(!is.na(logArea)) %>%
arrange(Date)
p <- ggplot(df_log, aes(x = Date, y = logArea, color = Compound)) +
geom_line() + geom_point() +
theme_minimal() +
labs(title = "Cin√©tique des Aires (log10) des √©talons internes",
y = "log10(Area)", x = "Date") +
theme(legend.position = "bottom")
ggsave(file, plot = p, width = 10, height = 6, dpi = 300)
}
)
#shinyDirChoose(input, "dir", roots = c(home = "~"), session = session)
volumes <- c(
"Home" = "C:/Users/Masspeclab",
"Bureau" = "C:/Users/Masspeclab/Desktop",
"Documents" = "C:/Users/Masspeclab/Documents"
)
shinyDirChoose(input, "dir", roots = volumes, session = session)
observeEvent(input$dir, {
dir_path <- parseDirPath(volumes, input$dir)
req(dir_path)
data_wide <- preprocess_folder_tenax(dir_path)  # üõ† utiliser le bon traitement global
if (nrow(data_wide) == 0) {
showModal(
modalDialog(
title = "Erreur de chargement",
div(style = "font-size:20px; color:red; text-align:center;",
"‚ùå Aucun fichier CSV exploitable trouv√©."),
easyClose = TRUE,
footer = modalButton("OK")
)
)
return(NULL)
}
output$download_formatted <- downloadHandler(
filename = function() paste0("tableau_formate_", Sys.Date(), ".csv"),
content = function(file) {
write_csv2(data_wide, file)
showNotification("‚úÖ Donn√©es format√©es pr√™tes au t√©l√©chargement.", type = "message")
}
)
})
# -- Choix dossier Tenax --
shinyDirChoose(input, "dir_tenax", roots = volumes, session = session)
observeEvent(input$dir_tenax, {
dir_path <- parseDirPath(volumes, input$dir_tenax)
req(dir_path)
files <- list.files(dir_path, pattern = "\\.csv$", full.names = TRUE)
if (length(files) == 0) {
showNotification("‚ùå Aucun fichier CSV trouv√©.", type = "error")
return()
}
all_tables <- map(files, function(filepath) {
df <- read_csv2(filepath, show_col_types = FALSE)
# --- D√©tection fichier brut ou d√©j√† r√©sum√© ---
if ("Sample" %in% names(df) && "Area" %in% names(df)) {
# ‚ö° Fichier brut : get_best_hits
best_hits <- df %>%
group_by(Sample, Compound) %>%
slice_max(order_by = Area, n = 1, with_ties = FALSE) %>%
ungroup()
date_extracted <- str_extract(basename(filepath), "\\d{8}")
date_formatted <- format(as.Date(date_extracted, "%d%m%Y"), "%Y-%m-%d")
best_hits %>%
group_by(Compound) %>%
summarise(
!!paste0("Area_", date_formatted) := mean(Area, na.rm = TRUE),
!!paste0("CV_", date_formatted) := sd(Area, na.rm = TRUE) / mean(Area, na.rm = TRUE) * 100,
.groups = "drop"
)
} else if (all(c("Compound", "Area", "CV") %in% names(df))) {
# ‚ö° Fichier d√©j√† r√©sum√©
df <- df %>%
mutate(Compound = as.character(Compound)) %>%
select(Compound, Area, CV)
date_extracted <- str_extract(basename(filepath), "\\d{8}")
date_formatted <- format(as.Date(date_extracted, "%d%m%Y"), "%Y-%m-%d")
df %>%
rename(
!!paste0("Area_", date_formatted) := Area,
!!paste0("CV_", date_formatted) := CV
)
} else {
# üõë Fichier non reconnu
return(tibble())
}
})
all_tables <- all_tables[map_lgl(all_tables, ~ nrow(.) > 0)]
if (length(all_tables) == 0) {
showNotification("‚ùå Aucun fichier exploitable Tenax.", type = "error")
return()
}
final_table <- reduce(all_tables, full_join, by = "Compound")
output$download_tenax <- downloadHandler(
filename = function() paste0("tenax_formate_", Sys.Date(), ".csv"),
content = function(file) {
write_csv2(final_table, file)
showNotification("‚úÖ Donn√©es Tenax pr√™tes au t√©l√©chargement.", type = "message")
}
)
})
# -- Choix dossier Plasma --
shinyDirChoose(input, "dir_plasma", roots = volumes, session = session)
observeEvent(input$dir_plasma, {
dir_path <- parseDirPath(volumes, input$dir_plasma)
req(dir_path)
files <- list.files(dir_path, pattern = "\\.csv$", full.names = TRUE)
if (length(files) == 0) {
showModal(modalDialog(title = "Erreur", "Aucun fichier CSV trouv√©."))
return()
}
all_tables <- map(files, function(filepath) {
df <- preprocess_single_file(filepath)
if (nrow(df) == 0) return(tibble())
best_hits <- df %>%
group_by(Sample, Compound) %>%
slice_max(order_by = Area, n = 1, with_ties = FALSE) %>%
ungroup()
date_extracted <- str_extract(basename(filepath), "\\d{8}")
date_formatted <- format(as.Date(date_extracted, "%d%m%Y"), "%Y-%m-%d")
best_hits %>%
group_by(Compound) %>%
summarise(
!!paste0("Area_", date_formatted) := mean(Area, na.rm = TRUE),
!!paste0("CV_", date_formatted) := sd(Area, na.rm = TRUE) / mean(Area, na.rm = TRUE) * 100,
.groups = "drop"
)
})
all_tables <- all_tables[map_lgl(all_tables, ~ nrow(.) > 0)]
if (length(all_tables) == 0) {
showNotification("Aucune donn√©e Plasma exploitable.", type = "error")
return()
}
final_table <- reduce(all_tables, full_join, by = "Compound")
output$download_plasma <- downloadHandler(
filename = function() paste0("plasma_formate_", Sys.Date(), ".csv"),
content = function(file) {
write_csv2(final_table, file)
showNotification("‚úÖ Donn√©es Plasma pr√™tes au t√©l√©chargement.", type = "message")
}
)
})
observeEvent(input$tenax_dir, {
volumes <- c(Home = fs::path_home(), "R" = getwd())
shinyDirChoose(input, "tenax_dir", roots = volumes, session = session)
tenax_path <- parseDirPath(volumes, input$tenax_dir)
req(tenax_path)
tenax_final <- preprocess_folder_tenax(tenax_path)
if (nrow(tenax_final) == 0) {
showNotification("‚ùå Aucun fichier Tenax exploitable.", type = "error")
return()
}
output$tenax_export <- downloadHandler(
filename = function() {
paste0("tenax_formate_", Sys.Date(), ".csv")
},
content = function(file) {
write_csv2(tenax_final, file)
showNotification("‚úÖ Fichier Tenax format√© pr√™t !", type = "message")
}
)
})
observeEvent(input$tenax_summary_file, {
req(input$tenax_summary_file)
df <- read_csv2(input$tenax_summary_file$datapath)
df_long <- df %>%
pivot_longer(cols = starts_with("Area_"), names_to = "Measure", values_to = "Area") %>%
mutate(
DateRaw = str_remove(Measure, "Area_"),
DateLabel = factor(DateRaw, levels = unique(DateRaw)),  # ‚ûú garde l‚Äôordre d‚Äôapparition
Date = as.Date(str_extract(DateRaw, "\\d{4}-\\d{2}-\\d{2}")),  # ‚ûú utile pour d'autres usages
Compound = as.character(Compound)
)
output$tenax_summary_table <- renderDT({
datatable(df, options = list(scrollX = TRUE, pageLength = 10))
})
output$tenax_summary_plot <- renderPlotly({
df_long_sorted <- df_long %>%
arrange(Compound, Date)
p <- ggplot(df_long_sorted, aes(x = DateLabel, y = Area, group = Compound, color = Compound)) +
geom_line() +
geom_point() +
theme_minimal() +
labs(title = "√âvolution des aires moyennes (Tenax)",
x = "Date/nom du fichier", y = "Aire") +
theme(
legend.position = "bottom",
axis.text.x = element_text(angle = 60, hjust = 1, size = 8)  # ‚Üê rotation + lisibilit√©
)
ggplotly(p)
})
output$tenax_cv_plot <- renderPlotly({
req(input$tenax_summary_file)
df <- read_csv2(input$tenax_summary_file$datapath, show_col_types = FALSE)
# ‚úÖ V√©rifie que CV_Global existe
if (!"CV_Global" %in% colnames(df)) {
return(plotly_empty(type = "scatter", mode = "markers") %>%
layout(title = "Aucune colonne 'CV_Global' trouv√©e"))
}
df <- df %>%
mutate(
is_extreme = Compound %in% c("Acetone", "Acetonitrile"),
CV_Global = as.numeric(str_replace(as.character(CV_Global), ",", "."))
)
df_normaux <- df %>% filter(!is_extreme)
df_extremes <- df %>% filter(is_extreme)
trace_normaux <- plot_ly(df_normaux, x = ~Compound, y = ~CV_Global, type = "bar",
name = "CV standards", marker = list(color = 'steelblue'),
yaxis = "y")
trace_extremes <- plot_ly(df_extremes, x = ~Compound, y = ~CV_Global, type = "bar",
name = "CV extr√™mes", marker = list(color = 'firebrick'),
yaxis = "y2")
subplot(trace_normaux, trace_extremes) %>%
layout(
title = "CV global (%) par compos√© (double axe Y)",
xaxis = list(title = "Compos√©s"),
yaxis = list(
title = "CV standards",
side = "left",
overlaying = NULL
),
yaxis2 = list(
title = "CV extr√™mes",
side = "right",
overlaying = "y",
showgrid = FALSE
),
shapes = list(
list(
type = "line",
x0 = -0.5,
x1 = nrow(df) - 0.5,  # ‚úÖ plus s√ªr que length(df$Compound)
y0 = 30,
y1 = 30,
yref = "y",
line = list(color = "red", dash = "dash")
)
),
legend = list(orientation = "h", x = 0.1, y = 1.1)
)
})
})
output$retentio2_ui <- renderUI({
tagList(
fluidRow(
valueBoxOutput("cvBox2"),
valueBoxOutput("meanBox2"),
conditionalPanel(condition = "output.showSequenceBox2", valueBoxOutput("nSeqBox2")),
conditionalPanel(condition = "output.showCVFAME2", valueBoxOutput("cvBoxFAME2")),
valueBoxOutput("cvBoxInterne2")
),
fluidRow(
box(title = "Fichiers charg√©s", width = 12,
verbatimTextOutput("loadedFiles2"),
verbatimTextOutput("data_summary2"))
),
fluidRow(
tabBox(title = "Visualisation", width = 12,
tabPanel("CV% par s√©quence", plotlyOutput("CVPlot_time2")),
tabPanel("Aires par Date", plotlyOutput("trendPlot2")),
tabPanel("Aires par date d√©sordonn√©", plotlyOutput("areaPlot2")),
tabPanel("Cin√©tiques multi-compos√©s",
downloadButton("download_cv_plot2", "T√©l√©charger CV (%) PNG"),
downloadButton("download_area_plot2", "T√©l√©charger Aire (log10) PNG"),
plotlyOutput("multiCVPlot2"),
plotlyOutput("multiAreaPlot2"))
)
),
fluidRow(box(title = "Donn√©es filtr√©es", width = 12, DTOutput("dataTable2"))),
fluidRow(
downloadButton("downloadCSV2", "T√©l√©charger CSV nettoy√©"),
actionButton("zoom_issues2", "Zoom sur probl√®mes"),
actionButton("manual_correct2", "Corriger manuellement")
)
)
})
}
# ---- APP ----
shinyApp(ui, server)
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
output$trendPlot2 <- renderPlotly({
df <- filtered_data_2()
# üîç Nettoyage robustes des valeurs d√©cimales
df$Area <- as.numeric(gsub(",", ".", as.character(df$Area)))
# üìä Calcul Min / Max / Moyenne
summary <- df %>%
group_by(Date) %>%
summarise(
Min = min(Area, na.rm = TRUE),
Max = max(Area, na.rm = TRUE),
Mean = mean(Area, na.rm = TRUE),
.groups = "drop"
)
print(summary)  # ‚ö†Ô∏è √Ä v√©rifier dans la console RStudio
# üìà Affichage forc√© avec couleurs + styles distincts
plot_ly(summary, x = ~Date) %>%
add_lines(y = ~Min, name = "Min", line = list(color = "blue", width = 2)) %>%
add_markers(y = ~Min, marker = list(color = "blue", size = 5)) %>%
add_lines(y = ~Mean, name = "Moyenne", line = list(color = "orange", width = 2, dash = "dash")) %>%
add_markers(y = ~Mean, marker = list(color = "orange", size = 5)) %>%
add_lines(y = ~Max, name = "Max", line = list(color = "green", width = 2)) %>%
add_markers(y = ~Max, marker = list(color = "green", size = 5)) %>%
layout(
yaxis = list(title = "Tendance des Aires", type = "log"),  # ‚ûï optionnel : log pour mieux voir les diff√©rences
legend = list(x = 0.05, y = 0.95)
)
})
print(summary)
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
le filtrage est parfait dans longlet plasma nickel, mais mtn je le veux aussi dans longlet tenax parfaitement sans rien alterer dautre
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
library(shiny); runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
runApp('Retentio.R')
